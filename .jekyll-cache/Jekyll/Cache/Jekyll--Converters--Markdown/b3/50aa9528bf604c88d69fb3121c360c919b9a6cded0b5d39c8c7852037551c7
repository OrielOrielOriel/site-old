I"x.<p><br /></p>

<blockquote>
  <p>A log of how I did the TryHackMe room EnterPrize by superhero1</p>
</blockquote>

<p><br /></p>

<h1 id="enterprize">EnterPrize</h1>
<h2 id="enumerating-web-presence">Enumerating Web Presence</h2>
<p>My initial portscan finds ports 22, 80, and 443 open.</p>

<p>Checking the web server, I’m greeting a message <code class="language-plaintext highlighter-rouge">nothing to see here</code>. I add <code class="language-plaintext highlighter-rouge">enterprize.thm</code> to my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> and begin to fuzz for subdomains and subdirectories.</p>

<p>I find a loose <code class="language-plaintext highlighter-rouge">composer.json</code> file:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"superhero1/enterprize"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"THM room EnterPrize"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"project"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"typo3/cms-core"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9.5"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"guzzlehttp/guzzle"</span><span class="p">:</span><span class="w"> </span><span class="s2">"~6.3.3"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"guzzlehttp/psr7"</span><span class="p">:</span><span class="w"> </span><span class="s2">"~1.4.2"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"typo3/cms-install"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9.5"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"typo3/cms-backend"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9.5"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"typo3/cms-core"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9.5"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"typo3/cms-extbase"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9.5"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"typo3/cms-extensionmanager"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9.5"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"typo3/cms-frontend"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9.5"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"typo3/cms-install"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9.5"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"typo3/cms-introduction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.0"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GPL"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"minimum-stability"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stable"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This file proves important later.</p>

<p>The subdomain bruteforce returns a site at <code class="language-plaintext highlighter-rouge">maintest.enterprize.thm</code>, so I add that to my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> and fuzz that site for subdirectories to find <code class="language-plaintext highlighter-rouge">fileadmin</code>, <code class="language-plaintext highlighter-rouge">typo3conf</code>, <code class="language-plaintext highlighter-rouge">typo3temp</code>, and <code class="language-plaintext highlighter-rouge">typo3</code>.</p>

<h2 id="typo3-deserialization">Typo3 Deserialization</h2>
<p>I was able to find the following <code class="language-plaintext highlighter-rouge">LocalConfiguration.old</code> file in the <code class="language-plaintext highlighter-rouge">/typo3conf/</code> subdirectory.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
	<span class="o">&lt;--</span><span class="no">SNIPPED</span><span class="o">--&gt;</span>
    <span class="s1">'SYS'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'devIPmask'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'displayErrors'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'encryptionKey'</span> <span class="o">=&gt;</span> <span class="s1">'712dd4d9c583482940b75514e31400c11bdcbc7374c8e62fff958fcd80e8353490b0fdcf4d0ee25b40cf81f523609c0b'</span><span class="p">,</span>
        <span class="s1">'exceptionalErrors'</span> <span class="o">=&gt;</span> <span class="mi">4096</span><span class="p">,</span>
        <span class="s1">'features'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'newTranslationServer'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s1">'unifiedPageTranslationHandling'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">'sitename'</span> <span class="o">=&gt;</span> <span class="s1">'EnterPrize'</span><span class="p">,</span>
        <span class="s1">'systemLogLevel'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">'systemMaintainers'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div>

<p>The relevant portion here will end up being the <code class="language-plaintext highlighter-rouge">encryptionKey</code>. Doing some research into the <a href="https://github.com/TYPO3/typo3">Typo3</a> CMS and  the dependencies from the <code class="language-plaintext highlighter-rouge">composer.json</code> file led me to <a href="https://www.synacktiv.com/publications/typo3-leak-to-remote-code-execution.html">this</a> disclosure by <a href="https://www.synacktiv.com/index.html">Synacktiv</a>.</p>

<p>The context allowing for the vulnerability prerequisites (Knowledge of the <code class="language-plaintext highlighter-rouge">encryptionKey</code>), is different between their post and this situation, but regardless, I have access to the key so I continued to research the vulnerability.</p>

<p><a href="https://www.synacktiv.com/index.html">For a deeper look into the source code enabling this vulnerability, give the blog post a read; it’s well written and informative.</a></p>

<blockquote>
  <p>The <em><code class="language-plaintext highlighter-rouge">initializeFormStateFromRequest()</code></em> function in Typo3 will insecurely deserialize arbitary data if it is received in a POST request form body with a valid HMAC signature.</p>

  <p>The <em><code class="language-plaintext highlighter-rouge">"guzzlehttp/guzzle": "~6.3.3"</code></em> dependency provides a gadget chain that can be used for remote code execution upon deserialization.</p>
</blockquote>

<p>I use <a href="https://github.com/ambionics/phpggc"><code class="language-plaintext highlighter-rouge">phpgcc</code></a> to create a remote code execution payload which will write a webshell to the publically accessible <code class="language-plaintext highlighter-rouge">/fileadmin/_temp_/</code> directory. After signing it with an HMAC created with the <code class="language-plaintext highlighter-rouge">encryptionKey</code>, I send the malicious serialized payload in a POST form found on the website.</p>

<p>Navigating to the webshell allows me to execute arbitrary commands on the underlying machine and I catch a reverse shell as <code class="language-plaintext highlighter-rouge">www-data</code>.</p>

<h2 id="symlink-and-malicious-library">Symlink and Malicious Library</h2>
<p>While enumerating the machine as <code class="language-plaintext highlighter-rouge">www-data</code>, I find a custom binary named <code class="language-plaintext highlighter-rouge">myapp</code> in the <code class="language-plaintext highlighter-rouge">/home/john</code> directory. Looking around the filesystem reveals the following symlink:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/ld.so.conf.d/x86_64-libc.conf -&gt; /home/john/develop/test.conf
</code></pre></div></div>

<p>Using the <code class="language-plaintext highlighter-rouge">ldd</code> command on <code class="language-plaintext highlighter-rouge">myapp</code> shows the <code class="language-plaintext highlighter-rouge">/lib/libcustom.so</code> library as a dependency. This library contains the <code class="language-plaintext highlighter-rouge">do_ping()</code> function which I overwrite by compiling a malicious <code class="language-plaintext highlighter-rouge">do_ping()</code> function in a my own <code class="language-plaintext highlighter-rouge">libcustom.so</code> file which I store in the <code class="language-plaintext highlighter-rouge">/home/john/develop/</code> directory.</p>

<p>After that I write <code class="language-plaintext highlighter-rouge">/home/john/develop/</code> in the <code class="language-plaintext highlighter-rouge">test.conf</code> file to make the <code class="language-plaintext highlighter-rouge">myapp</code> file load my malicious library and execute my <code class="language-plaintext highlighter-rouge">do_ping()</code> function.</p>

<p>I use this exploit to copy my ssh public key into john’s <code class="language-plaintext highlighter-rouge">authorized_keys</code> file and am now able to ssh as the user <code class="language-plaintext highlighter-rouge">john</code>.</p>

<h2 id="local-port-forwading-and-nfs-no_root_squash">Local Port Forwading and NFS no_root_squash</h2>
<p>Once authenticated as <code class="language-plaintext highlighter-rouge">john</code> I run <em>linpeas.sh</em> to find port 2049 is running, and that the <code class="language-plaintext highlighter-rouge">no_root_squash</code> parameter is enabled for <code class="language-plaintext highlighter-rouge">/var/nfs</code>.</p>

<p>To exploit this vulnerability I use ssh to port forward <code class="language-plaintext highlighter-rouge">127.0.0.1:2049</code> to a port on my own machine and mount the <code class="language-plaintext highlighter-rouge">/var/nfs</code> share.</p>

<p>On my machine, I copy <code class="language-plaintext highlighter-rouge">/bin/bash</code> as <code class="language-plaintext highlighter-rouge">root</code> and chmod it to have the SUID property. I copy it into the mounted directory and use run it with the <code class="language-plaintext highlighter-rouge">-p</code> flag on the victim machine to generate a shell as <code class="language-plaintext highlighter-rouge">root</code>.</p>
:ET